---
title: "Southern African Regional OES MIS2"
author: "Amy Hatton"
date: "16/02/2021"
output: html_document
---

#Install Packages 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(sp)
library(ggplot2)
library(ggspatial)
library(tmap)
library(raster)
library(rgdal)
library(stars)
library(tidyverse)
library(janitor)
```

# Read in the csv and convert to a spatial object
```{r}
sa_beads <- read.csv("../../General Data southern africa/SouthernAfricanOESBeadData_revised.csv")


#convert to sf object
sa_beads_sf <- st_as_sf(sa_beads, coords = c("Long","Lat" ),
                     crs = 4326)
#st_write(sa_beads_sf,"nok_spatial_data/sa_beads_mis2.gpkg", append = FALSE)
#summary(sa_beads)
```

Get the distances between a few of the sites for the text 
```{r}
st_distance(sa_beads_sf[23,], sa_beads_sf[25,])
```
## Prep the Data for plotting the pie charts (preforms vs finished beads)
```{r}
sa_beads <- clean_names(sa_beads)
names(sa_beads)

sa_beads$beads_finished <- as.numeric(sa_beads$beads_finished)
sa_beads$beads_preforms <- as.numeric(sa_beads$beads_preforms)
sa_beads$oes_fragments <- as.numeric(sa_beads$oes_fragments)

beads_mis2 <- sa_beads %>% 
  dplyr::select(site_abb, beads_finished, beads_preforms,oes_fragments,mean_diameter_mm, long, lat) %>% 
  mutate(oes_total = beads_finished + beads_preforms + oes_fragments,
         bead_total = beads_finished + beads_preforms) %>% 
  group_by(site_abb) %>% 
  summarise(beads_finished = mean(beads_finished),
            beads_preforms = mean(beads_preforms),
            oes_fragments = mean(oes_fragments),
            bead_total = mean(bead_total),
            oes_total = mean(oes_total),
            diameter = mean(mean_diameter_mm),
            long = mean(long),
            lat = mean(lat)) %>% 
  mutate(fin_prop = beads_finished/bead_total, pre_prop = beads_preforms/bead_total,
         fin_vs_oes_prop = beads_finished/oes_total, oes_prop = (beads_preforms + oes_fragments)/oes_total) 
```



# 1) Plot a Raster of southern africa as base plot to plot the pie charts on top of. 

## Import the raster

Use the stars package - allows you to downsample when plotting - code runs much faster!

```{r}
sa_dem <- raster("nok_spatial_data/sa_dem_srtm90.tif")
sa_borders <- st_read("nok_spatial_data/southern_africa_borders.gpkg")
sa_borders <- st_transform(sa_borders, 4326)
#st_write(sa_borders, "nok_spatial_data/southern_africa_borders_epsg4326.gpkg")

#create bounding box for sa_borders
library(rgeos)

extent(sa_borders)
my_box <- rgeos::bbox2SP(n = -16.95106 , s = -34.82195 , w = 11.71762, e = 32.89308,
                         proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
my_box <- st_as_sf(my_box, 4326)
```


```{r}
#get the polygons for other countries (zambia etc)
library(rnaturalearth)
s <- ne_countries(scale = "large", type = "countries", continent = "africa",
  returnclass =  "sf")
s1 <- s %>% 
  filter(name == "Angola" | name == "Zambia" | name == "Zimbabwe"|name == "Mozambique" |
           name == "South Africa" | name == "eSwatini" | name == "Namibia" | name == "Botswana" |
           name == "Lesotho")
s1 <- st_transform(s1, 4326)

#get the intersection of the sa bbox and this 
a_borders <- st_intersection(my_box, s1)
#st_write(a_borders, "nok_spatial_data/oes_paper_sa_map/a_borders.gpkg", append =FALSE)

#downsample the raster (make the resolution more coarse)
sa_dem_agg <- aggregate(sa_dem, fact=8)

#clip the dem to borders
dem_clip <- mask(sa_dem_agg, a_borders)

#create hillshade for plotting
#slope <- terrain(dem_clip,opt = "slope",unit = "radians" )
#aspect <- terrain(dem_clip, opt="aspect", unit = "radians")
#hs <- hillShade(slope, aspect, angle = 35)
hs <- raster("nok_spatial_data/oes_paper_sa_map/sa_hs.tif")
#remove aspect and slope
rm(aspect)
rm(slope)
rm(sa_dem_agg)
```

## Read in ostrich species distribution data from SABAP2 (http://sabap2.birdmap.africa/)

```{r}

oes_dist <- st_read("nok_spatial_data/SABAP2_ostrich_distribution.gpkg")
```
### Rasterise the OES data
```{r}
ext <- extent(oes_dist)
r <- raster(ext, res=c(1/12,1/12))  #resolution of SABAP2 is 1/9 (1/3 x 1/3) of a quarter degree lat long square
r <- rasterize(oes_dist, r, field="full.protocol")
```


### Interpolate the OES distribution data using ordinary kriging
```{r}
library(gstat)
library(automap)

#convert ostrich raster to points
p <- rasterToPoints(r, spatial = TRUE)
#p1 <- as(p, "SpatialPointsDataFrame")

pred <- autoKrige(layer~1, p)
oes_pred <- pred$krige_output
```


```{r}
#rasterise prediction
r1 <- raster(oes_pred)
#create raster with extent that I want 
ext <- extent(11.6,33, -34.2, -16.8)
r1 <- extend(r1, ext, value = NA)

```

# expand the edges of raster to fill the whole of southern africa (was stopping short of some borders)
```{r}
#calculate distance from all cells with values to all NA cells
dist <- distance(r1)  
# you can also set a maximum distance: dist[dist > maxdist] <- NA
dist[dist > 3] <- NA
plot(dist)

direct <- direction(r1, from=FALSE)
```
Retrieve the coordinates of nearest non - NA cells
```{r}
# NA raster
rna <- is.na(r1) # returns NA raster

# store coordinates in new raster 
na.x <- init(rna, 'x')
na.y <- init(rna, 'y')

# calculate coordinates of the nearest Non-NA pixel
# assume that we have a orthogonal, projected CRS, so we can use (Pythagorean) calculations
co.x <- na.x + dist * sin(direct)
co.y <- na.y + dist * cos(direct)

# matrix with point coordinates of nearest non-NA pixel
co <- cbind(co.x[], co.y[]) 
```

```{r}
# extract values of nearest non-NA cell with coordinates co
NAVals <- raster::extract(r1, co, method='simple') 
r.NAVals <- rna # initiate new raster
r.NAVals[] <- NAVals # store values in raster
```
```{r}
# cover nearest non-NA value at NA locations of original raster
r.filled <- cover(x=r1, y= r.NAVals)
```

```{r}
#make the resolution finer to allow for nice plotting (not good for analysis but fine for visualising)
r1_agg <- disaggregate(r.filled, fact=25)

crs(r1_agg) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" 
writeRaster(r1_agg, "nok_spatial_data/oes_paper_sa_map/oes_pred_rast.tiff", overwrite=TRUE)

crs(r1_agg)
```

```{r}
#crop to southern africa 
r2 <- mask(r1_agg, a_borders)
oes_pred_sa <- crop(r2, a_borders)
plot(oes_pred_sa)

extent(oes_pred_sa)
st_bbox(a_borders)
writeRaster(oes_pred_sa, "nok_spatial_data/oes_paper_sa_map/ostrich_pred.tif", overwrite = TRUE)
st_write(a_borders, "nok_spatial_data/oes_paper_sa_map/a_borders.gpkg", append = FALSE)
writeRaster(dem_clip, "nok_spatial_data/oes_paper_sa_map/sa_dem.tif", overwrite = TRUE)
crs(r1_agg)
#make stars object
oes_pred_stars <- st_as_stars(oes_pred_sa)
```


Convert the clipped dem to a df for plotting with ggplot
```{r}
# convert to a df for plotting in two steps,
# First, to a SpatialPointsDataFrame
dem_pts <- rasterToPoints(dem_clip, spatial = TRUE)
# Then to a 'conventional' dataframe
dem_df  <- data.frame(dem_pts)
#rm(dem_pts, dem_clip)
```

### Pretty map code
```{r}
library(ggplot2) # For map design
library(ggspatial) # For map design
library(ggrepel)  # For map design
library(patchwork) # For multiple map layout
library(raster) # For manage raster data
library(sf) # For manage vector data


pal <- rev(RColorBrewer::brewer.pal(8, "RdYlBu"))
pal1 <- rev(c("#d7191c", "#fdae61", "#ffffbf", "#abdda4", "#2b83ba"))
pal2 <- (RColorBrewer::brewer.pal(5, "BrBG"))
pal3 <- c("#defae1", "#addbb2", "#67b5a5", "#2986ab", "#2c5f96")
#convert to a stars object
hs_stars <- st_as_stars(hs)

#### Working plot
hillshade <- ggplot() + 
   geom_stars(data =hs_stars, downsample = 5, show.legend = FALSE) +
   scale_fill_continuous( low = "black", high = "white",
                          na.value = "white")+
  coord_equal()+
   theme_bw() +
    scale_x_continuous(expand=c(0,0))+
    scale_y_continuous(expand=c(0,0))

#layer 2 - elevation data
dem_map <- ggplot()+
  geom_raster(data=dem_df, aes(x = x, y= y, fill = sa_dem_srtm90))+
  scale_fill_gradientn( colours=c("grey24","white"))+
  coord_equal()+
   theme_bw() +
    scale_x_discrete(expand=c(0,0))+
    scale_y_discrete(expand=c(0,0))
library(ggnewscale)
#layer 3 - ostrich distribution
p2 <- hillshade +
  new_scale("fill")+
  geom_stars(data = oes_pred_stars, alpha = 0.8) +
  scale_fill_gradientn(colours = pal3, limits = c(0, 100), na.value = "white") +
  labs(x = "Longitude", y = "Latitude", fill = "Modern Prevalence \nof Ostriches") +
  theme_bw()

# layer 4 country borders
#add the country borders
p3 <- p2 +
    geom_sf(data = a_borders, size =1.2, colour = "white", fill = NA)
```

# add the last layer (actual data) to each of the 4 maps

Map with sites and pie charts for preform/bead ratio
```{r}
#add the pie charts at sites for proportion beads to preforms

library(scatterpie)

library(ggrepel)

#mutate the lat and long column names for geom_scatterpie to work
beads_mis2 <- beads_mis2 %>% 
  mutate(long_geom = long) %>% 
  mutate(lat_geom = lat)
bead_data <- beads_mis2
pre_vs_oes <- beads_mis2 %>%  
  filter_at(vars(pre_prop, fin_prop), any_vars(!is.na(.)))

map1 <- p3+
  new_scale("fill")+
  geom_scatterpie(aes(x=long_geom, y=lat_geom, r=0.6), 
                  data=pre_vs_oes, cols=c("fin_prop", "pre_prop"), alpha = 0.8)+

  scale_fill_manual(name = "Type", labels = c("Finished Beads", "Preforms"), values = c("#fc9595", "#b488c8"))+
  geom_text_repel(data = pre_vs_oes, aes(x=long_geom, y=lat_geom, label=site_abb), point.padding =2, box.padding = 0.5)+
  theme(legend.position = "bottom")


## attempt 2 adjust lat and long to avoid overlapping - has to be done manually? can't find a function that works

#I want to move RCC, HM and NT because they are all bunched together 
#RCC is the 10th row, NT is the 9th row, HM is the 5th row

pdf("Plots/map1_mis2.pdf")
print(map1)
dev.off()

```


Map with frequencies of bead vs preforms +frags


```{r}
#filte out na's
bead_vs_oes <- beads_mis2 %>%  
  filter_at(vars(fin_vs_oes_prop, oes_prop), any_vars(!is.na(.)))

map2 <- p3+
  new_scale("fill")+
  geom_scatterpie(aes(x=long_geom, y=lat_geom, r=0.6), 
                  data=bead_vs_oes, cols=c("fin_vs_oes_prop", "oes_prop"), alpha = 0.8)+

  scale_fill_manual(name = "Type", labels = c("Finished Beads", "Preforms and\nOES Fragments"), values = c("#fc9595", "#b488c8"))+
  geom_text_repel(data = bead_vs_oes, aes(x=long_geom, y=lat_geom, label=site_abb), point.padding =2, box.padding = 0.5)+
  theme(legend.position = "bottom")

pdf("Plots/map2_mis2.pdf")
print(map2)
dev.off()

```

Map with OES bead + preform abundance
```{r}
library(viridis)

bead_count <- beads_mis2 %>%  
  filter_at(vars(bead_total), any_vars(!is.na(.)))

range(bead_count$bead_total)
map3 <- p3 +
  new_scale("fill")+
  geom_point( data=bead_count, aes(x=long_geom, y=lat_geom, size=bead_total, fill=bead_total), shape = 21, alpha = 0.7) +
  scale_size_continuous(range=c(1,10)) +
  scale_fill_viridis( option = "plasma", guide = "legend") +
  geom_text_repel(data = bead_count, aes(x=long_geom, y=lat_geom, label=site_abb), point.padding =2, box.padding = 0.5)+
  theme(legend.position = "bottom")+
  guides(fill=guide_legend("OES bead and preform\nabundance"),
         size=guide_legend("OES bead and preform\nabundance"))
  
pdf("Plots/map3_mis2.pdf")
print(map3)
dev.off()

```
Map with OES abundance (circles with diameter showing number of oes)
```{r}
oes_count <- beads_mis2 %>%  
  filter_at(vars(oes_total), any_vars(!is.na(.)))
range(oes_count$oes_total)
map4 <- p3 +
  new_scale("fill")+
  geom_point( data=oes_count, aes(x=long_geom, y=lat_geom, size=oes_total, fill=oes_total), shape = 21, alpha = 0.7) +
  scale_size_continuous(range=c(1,10)) +
  scale_fill_viridis( option = "plasma", guide = "legend") +
  geom_text_repel(data = oes_count, aes(x=long_geom, y=lat_geom, label=site_abb), point.padding =2, box.padding = 0.5)+
  theme(legend.position = "bottom")+
  guides(fill=guide_legend("OES Fragment\nAbundance"),
         size=guide_legend("OES Fragment\nAbundance"))
  
pdf("Plots/map4_mis2.pdf")
print(map4)
dev.off()
```
Map with diameter of beads
```{r}
bead_diam <- bead_data %>%  
  filter_at(vars(diameter), any_vars(!is.na(.)))

map5 <- p3 +
  new_scale("fill")+
  geom_point( data=bead_diam, aes(x=long_geom, y=lat_geom, size=diameter, fill=diameter), shape = 21, alpha = 0.7) +
  scale_size_continuous(range=c(2,7)) +
  scale_fill_viridis( option = "plasma", guide = "legend") +
  geom_text_repel(data = bead_diam, aes(x=long_geom, y=lat_geom, label=site_abb), point.padding =2, box.padding = 0.5)+
  theme(legend.position = "bottom")+
  guides(fill=guide_legend("Bead diameter"),
         size=guide_legend("Bead diameter"))
  
pdf("Plots/map5_mis2.pdf")
print(map5)
dev.off()
```






